{% extends 'xm2cloud_cmp/_layout.html' %}
{% load static %}


{% block styles %}
    {{ block.super }}
    <style type="text/css">
        #hostgroup_create_form table tr, #hostgroup_update_form table tr{
            height: 30px;
        }
    </style>
{% endblock %}

{% block main_container %}
<div class="easyui-layout" data-options="fit:true">
    <div class="absolute-head" data-options="region:'north',border:false" title="群组列表">
        <div class="head-content">
            <div class="lf active">
                <span>集群:</span>
                <select id="switch_cluster" class="easyui-combobox" data-options="width:'200px'">
                    <option value="">所有集群</option>
                    {% for cluster in clusters %}
                        {% if cluster.pk == clusterid %}
                            <option value="{{ cluster.pk }}" selected>{{ cluster.name }}</option>
                        {% else %}
                            <option value="{{ cluster.pk }}">{{ cluster.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <a id="hostgroup_search" href="#" class="easyui-linkbutton button-line-white button-line-unbackground">
                    <i class="fa fa-search"></i> 查询
                </a>
            </div>
        </div>
        <div class="action-content">
            <div class="lf">
                <a id="add" href="#" class="easyui-linkbutton button-line-white button-line-unbackground">
                    <i class="fa fa-plus fit-panel-font-awesome" aria-hidden="true"></i> 添加
                </a>
                <a id="modify" href="#" class="easyui-linkbutton button-line-white button-line-unbackground">
                    <i class="fa fa-pencil fit-panel-font-awesome" aria-hidden="true"></i> 修改
                </a>
                <a id="delete" href="#" class="easyui-linkbutton button-line-white button-line-unbackground">
                    <i class="fa fa-minus fit-panel-font-awesome" aria-hidden="true"></i> 删除
                </a>
                <a id="grant" href="#" class="easyui-linkbutton button-line-white button-line-unbackground">
                    <i class="fa fa-user-circle-o" aria-hidden="true"></i> 授权
                </a>
            </div>
            <div class="rt">
                <ul>
                    <li><input class="easyui-checkbox" checked> 自动刷新(60s)</li>
                    <li class="sep"></li>
                    <li><a _action="reload" href="#"><i class="fa fa-refresh fit-panel-font-awesome"></i> 刷新</a></li>
                </ul>
            </div>
            <div _action="add"></div>
            <div _action="modify"></div>
            <div _action="delete"></div>
            <div _action="grant"></div>
        </div>
    </div>
    <div class="absolute-body" data-options="region:'center',border:false">
        <table id="hostgroup_datagrid" class="easyui-datagrid" data-options="border:false"></table>
    </div>
</div>
{% endblock %}

{% block scripts%}
{{ block.super }}
<script type="text/javascript">
    var cluster_id = null
        ,refresh_timer = null
        ,ajax_csrf_token = "{{ csrf_token }}"
        ,host_list = "{% url 'xm2cloud_cmp:hosts' %}"
        ,cluster_list = "{% url 'xm2cloud_cmp:clusters' %}"
        ,dashboardurl = "{% url 'xm2cloud_cmp:dashboard' %}"
        ,hostgroup_list_api = "{% url 'xm2cloud_cmp:api_hostgroup_list' %}"
        ,hostgroup_create = "{% url 'xm2cloud_cmp:hostgroup_create' %}"
        ,hostgroup_create_api = "{% url 'xm2cloud_cmp:api_hostgroup_create' %}"
        ,hostgroup_update = "{% url 'xm2cloud_cmp:hostgroup_update' id=0 %}"
        ,hostgroup_update_api = "{% url 'xm2cloud_cmp:api_hostgroup_update' id=0 %}"
        ,hostgroup_delete_api = "{% url 'xm2cloud_cmp:api_hostgroup_delete' id=0 %}";

    // for auto load csrf_token
    $.ajaxSetup({data: {csrfmiddlewaretoken:  ajax_csrf_token}});

    // for init search cluster
    function switch_cluster() {
        var cluster_id = $('#switch_cluster').combobox('getValue')
            ,cluster_name = $('#switch_cluster').combobox('getText');
        $('#cluster_name').text(cluster_name);

        if(cluster_id==''){
            $('#hostgroup_datagrid').datagrid('load', {url: ''});
        }else{
            $('#hostgroup_datagrid').datagrid('load', {clusterId: cluster_id});
        }
    }
    function init_switch_cluster(){
        $('#switch_cluster').combobox({
           onChange: switch_cluster
        });
        $('#hostgroup_search').bind('click', function () {
            switch_cluster();
        });
    }

    // for init hostgroup_datagrid
    function init_hostgroup_datagrid(api, data) {
        var get_data = data?data:{};
        $('#hostgroup_datagrid').datagrid({
            url: api,
            fit: true,
            method: 'GET',
            queryParams: get_data,
            pageSize: 20,
            striped: false,
            remoteSort: false,
            rownumbers: true,
            pagination: true,
            fitColumns: true,
            singleSelect: true,
            checkOnSelect: true,
            selectOnCheck: true,
            onLoadSuccess: function (data) {
                // for instance operator menubutton
                var row_num = $(this).datagrid('getRows').length;
                for(var i=0; i<row_num; i++){
                    var mbutton_id = 'mb_'+i;
                    $('#'+mbutton_id).menubutton({menu: '#mt_'+i});
                }
            },
            columns:[[
                {
                    field:'id',width:'4%',title:'序号',sortable:true
                },
                {
                    field:'name',width:'25.2%',title:'群组名称',sortable:true
                },
                {
                    field:'hosts',width:'10%',title:'主机数量',sortable:true,align:'center',
                    formatter: function(value, row, index){
                        var host_href = host_list + '?clusterId='+row.cluster.id+'&hostgroupId='+row.id;
                        return '<a class="inner-link" href="'+host_href+'"><span class="text-left">'+row.hosts+'</span><span class="text-right">个主机</span></a>';
                    }
                },
                {
                    field:'notes',width:'30%',title:'备注'
                },
                {
                    field:'create_time',width:'15%',title:'创建时间',align:'center',sortable:true
                },
                {
                    field:'operations',width:'10%',title:'操作',align:'center',
                    formatter: function(value, row, index){
                        var tools = '<a id="mb_'+index+'" class="easyui-menubutton button-line-white button-line-unbackground"> '
                                  + '<i class="fa fa-cog"></i> 操作 </a>';
                        var extra = '<div id="mt_'+index+'" class="operation-mt" style="display: none;">'
                                  + '<div>参数设置</div>'
                                  + '<div>脚本执行</div>'
                                  + '<div>告警日志</div></div>';
                        return tools + extra;
                    }
                },
                {
                    field:'alerts',width:'5%',title:'告警',align:'right'
                }
            ]],
            view: detailview,
            detailFormatter: function (index, row) {
                var body_detail = '<ul>';
                for(var i=0;i<row.hosts_annotate.length; i++){
                    var item = row.hosts_annotate[i];
                    var host_href = host_list + '?clusterId='+row.cluster.id+'&hostgroupId='+row.id+'&continentId='+item[0];
                    body_detail +='<li><span class="key">'+item[1]+'</span><a target="_blank" href="'+host_href
                                +'"><span class="val extranal-link">'
                                +item[2]+'</span> 台</a></li>';
                }
                body_detail += '</ul>';
                var detail_html = '<div class="detail-row">'
                                + '<div class="detail-row-head">'
                                + '<p>提示: 点击进入对应主机列表.</p>'
                                + '</div>'
                                + '<div class="detail-row-body">'
                                + body_detail
                                + '</div>'
                                + '</div>';
                return detail_html;
            }
        });
    }

    // for auto reload data from django app backend when click
    function auto_reload_hostgroup_datagrid() {
        $('div.action-content .rt span.checkbox-inner').on('click', function () {
            var status = $(this).children('span.checkbox-checked').css('display') == 'none';
            if(status){
                refresh_timer = setInterval(function () {
                    $('#cluster_datagrid').datagrid('reload');
                }, 60000)
            }else{
                if(refresh_timer) clearInterval(refresh_timer);
            }
        });
    }

    // for handler add/modify/delete/grant action
    function cluster_action_handler() {
        $('div.action-content div.lf>a').on('click', function () {
            var action = $(this).attr('id');
            switch(action){
                case 'add':
                    $('div[_action='+action+']').dialog({
                        width: 480,
                        height: 270,
                        cache: false,
                        modal: false,
                        closed: false,
                        title: '新建群组',
                        resizable: false,
                        href: hostgroup_create,
                        cls: 'messager-window',
                        buttons: [{
                            text: '<i class="fa fa-check font-green"></i> 保存',
                            handler: function () {
                                $.ajax({
                                    type: 'POST',
                                    url: hostgroup_create_api,
                                    data: {
                                        cluster: $('#hostgroup_create_form select[textboxname="cluster"]').textbox('getValue'),
                                        name: $('#hostgroup_create_form input[textboxname="name"]').textbox('getText'),
                                        notes: $('#hostgroup_create_form input[textboxname="notes"]').textbox('getText'),
                                        alertcontactgroup: $('#hostgroup_create_form select[textboxname="alertcontactgroup"]').textbox('getValue')
                                    },
                                    dataType: 'json',
                                    success: function (data, textStatus, jqXHR) {
                                        $('div[_action='+action+']').dialog('close');
                                        $.messager.alert('提示', data.msg, data.success==0 && 'info' || 'error', function () {
                                            $('#hostgroup_datagrid').datagrid('reload');
                                        });
                                    },
                                    error: function (jqXHR, error, exception) {
                                        $('div[_action='+action+']').dialog('close');
                                        $.messager.alert('错误', '未知错误', 'error');
                                    }
                                });
                            }
                        },
                        {
                            text: '<i class="fa fa-times font-red"></i> 取消',
                            handler: function () {
                                $('div[_action='+action+']').dialog('close');
                            }
                        }]
                    });
                    break;
                case 'modify':
                    var selected = $('#hostgroup_datagrid').datagrid('getSelected');
                    if(selected) {
                        var hostgroup_update_url = hostgroup_update_api.replace('/0/', '/'+selected.id+'/')
                            ,hostgroup_update_href = hostgroup_update.replace('/0/', '/'+selected.id+'/');
                        $('div[_action='+action+']').dialog({
                            width: 480,
                            height: 270,
                            cache: false,
                            modal: false,
                            closed: false,
                            title: '修改群组:'+selected.name,
                            resizable: false,
                            href: hostgroup_update_href,
                            cls: 'messager-window',
                            buttons: [{
                                text: '<i class="fa fa-check font-green"></i> 保存',
                                handler: function () {
                                    $.ajax({
                                        type: 'POST',
                                        url: hostgroup_update_url,
                                        data: {
                                            cluster: $('#hostgroup_update_form select[textboxname="cluster"]').textbox('getValue'),
                                            name: $('#hostgroup_update_form input[textboxname="name"]').textbox('getText'),
                                            notes: $('#hostgroup_update_form input[textboxname="notes"]').textbox('getText'),
                                            alertcontactgroup: $('#hostgroup_update_form select[textboxname="alertcontactgroup"]').textbox('getValue')
                                        },
                                        dataType: 'json',
                                        success: function (data, textStatus, jqXHR) {
                                            $('div[_action='+action+']').dialog('close');
                                            $.messager.alert('提示', data.msg, data.success == 0 && 'info' || 'error', function () {
                                                $('#hostgroup_datagrid').datagrid('reload');
                                            });
                                        },
                                        error: function (jqXHR, error, exception) {
                                            $('div[_action=' + action + ']').dialog('close');
                                            $.messager.alert('错误', '未知错误', 'error');
                                        }
                                    });
                                }

                            },
                            {
                                text: '<i class="fa fa-times font-red"></i> 取消',
                                handler: function () {
                                    $('div[_action='+action+']').dialog('close');
                                }
                            }]
                        });
                    }else{
                        $.messager.alert('错误', '请选择一条记录', 'error');
                    };
                    break;
                case 'delete':
                    var selected = $('#hostgroup_datagrid').datagrid('getSelected');
                    if(selected){
                        var hostgroup_delete_url = hostgroup_delete_api.replace('/0/', '/' + selected.id + '/');
                        $.messager.confirm('确认框', '你确定要删除群组: '+selected.name+' 吗?', function (res) {
                            if(!res) return;
                            $.ajax({
                                type: 'POST',
                                url: hostgroup_delete_url,
                                data: {},
                                success: function (data, textStatus, jqXHR) {
                                    $.messager.alert('提示', data.msg, data.success == 0 && 'info' || 'error', function () {
                                        $('#hostgroup_datagrid').datagrid('reload');
                                    });
                                },
                                error: function (jqXHR, error, exception) {
                                    $.messager.alert('错误', '未知错误', 'error');
                                }
                            });
                        });
                    }else{
                        $.messager.alert('错误', '请选择一条记录', 'error');
                    };
                    break;
                case 'grant':
                    $.messager.alert('通知', '全新的变革,即将上线!', 'info');
                    break
            }
        });
    }

    // customer scripts entry
    $(function () {
        // got cluster id from location
        cluster_id = $.get_urlparam('clusterId');
        // for init pannel title
        var title = '<a href="'+dashboardurl+'">仪表盘</a><i class="step fa fa-angle-right"></i>'
                  + '<a href="'+ cluster_list+ '">集群[<span id="cluster_name">所有集群</span>]</a>'
                  + '<i class="step fa fa-angle-right"></i><a href="#">群组[所有群组]</a>';
        $('div.absolute-head').panel({title: title});

        // for init search cluster
        init_switch_cluster();

        // for init hostgroup_datagrid
        var query_params = cluster_id?{clusterId:cluster_id}:{};
        if(cluster_id) $('#switch_cluster').combobox('select', cluster_id);
        init_hostgroup_datagrid(hostgroup_list_api, query_params);

        // for bind refresh button with reload action
        $('[_action="reload"]').on('click', function () {
            $('#hostgroup_datagrid').datagrid('reload');
        });

        // for auto reload data from django app backend
        refresh_timer = setInterval(function () {
            $('#hostgroup_datagrid').datagrid('reload');
        }, 60000);
        auto_reload_hostgroup_datagrid(refresh_timer);

        // for handler add/modify/delete/grant action
        cluster_action_handler()
    });
</script>
{% endblock %}